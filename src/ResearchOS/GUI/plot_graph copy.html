<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interactive Directed Graph</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="graph-data.js"></script>
    <style>
        .node circle { fill: steelblue; stroke: #fff; stroke-width: 1.5px; }
        .node text { pointer-events: none; font-family: sans-serif; }
        .node:hover circle { fill: orange; }
        .highlight-node { fill: red; }
        .edge { stroke: gray; stroke-width: 1.5px; marker-end: url(#arrowhead); }
        .highlight-edge { stroke: red; stroke-width: 3px; }
        svg { width: 100%; height: 100%; display: block; }
        .view { cursor: move; }
    </style>
</head>
<body>
    <svg></svg>

    <script>
        const svg = d3.select('svg')
            .attr('width', window.innerWidth)
            .attr('height', window.innerHeight);

        const zoom = d3.zoom()
            .scaleExtent([0.5, 10])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });

        svg.call(zoom);
        const g = svg.append("g").attr('class', 'view');

        // Initialize the graph using graphData
        initializeGraph(graphData);

        function initializeGraph(data) {
            const width = svg.attr('width');
            const height = svg.attr('height');

            // Convert relative positions to absolute coordinates
            data.nodes.forEach(node => {
                node.x *= width;
                node.y *= height;
            });

            // Define arrow marker for edges
            g.append('defs').append('marker')
                .attr('id', 'arrowhead')
                .attr('viewBox', '0 -5 10 10')
                .attr('refX', 10)
                .attr('refY', 0)
                .attr('markerWidth', 6)
                .attr('markerHeight', 6)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M0,-5L10,0L0,5')
                .attr('fill', 'gray');

            // Draw edges
            const links = g.selectAll('.edge')
                .data(data.edges)
                .enter()
                .append('line')
                .attr('class', 'edge');

            // Update edge positions
            links
                .attr('x1', edge => data.nodes.find(n => n.id === edge.from).x)
                .attr('y1', edge => data.nodes.find(n => n.id === edge.from).y)
                .attr('x2', edge => data.nodes.find(n => n.id === edge.to).x)
                .attr('y2', edge => data.nodes.find(n => n.id === edge.to).y);

            // Create nodes
            const node = g.selectAll('.node')
                .data(data.nodes)
                .enter()
                .append('g')
                .attr('class', 'node');

            node.append('circle')
                .attr('r', 10)
                .on('click', selectNode);

            node.append('text')
                .attr('x', 0)
                .attr('y', -15)
                .attr('text-anchor', 'middle')
                .text(d => d.id);

            node.call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

            // Update positions
            node.selectAll('circle')
                .attr('cx', d => d.x)
                .attr('cy', d => d.y);

            node.selectAll('text')
                .attr('x', d => d.x)
                .attr('y', d => d.y - 15);
        }

        function selectNode(event, d) {
            if (event.defaultPrevented) return; // Drag event, not a click

            const isActive = d3.select(this).select('circle').classed('highlight-node');
            svg.selectAll('.node circle').classed('highlight-node', false);
            svg.selectAll('.edge').classed('highlight-edge', false);

            if (!isActive) {
                d3.select(this).select('circle').classed('highlight-node', true);
                svg.selectAll('.edge')
                    .filter(edge => edge.from === d.id || edge.to === d.id)
                    .classed('highlight-edge', true);
            }
        }

        function dragstarted(event, d) {
            d3.select(this).raise().classed("active", true);
        }

        function dragged(event, d) {
            d.x = event.x;
            d.y = event.y;
            d3.select(this).select('circle').attr("cx", d.x).attr("cy", d.y);
            d3.select(this).select('text').attr("x", d.x).attr("y", d.y - 15);
            svg.selectAll('.edge')
                .filter(edge => edge.from === d.id || edge.to === d.id)
                .each(function(edge) {
                    d3.select(this).attr('x1', edge.from === d.id ? d.x : +d3.select(this).attr('x1'))
                                   .attr('y1', edge.from === d.id ? d.y : +d3.select(this).attr('y1'))
                                   .attr('x2', edge.to === d.id ? d.x : +d3.select(this).attr('x2'))
                                   .attr('y2', edge.to === d.id ? d.y : +d3.select(this).attr('y2'));
                });
        }

        function dragended(event, d) {
            d3.select(this).classed("active", false);
        }
    </script>
</body>
</html>
